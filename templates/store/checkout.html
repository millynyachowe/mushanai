{% extends 'base.html' %}

{% block title %}Checkout - Mushanai{% endblock %}

{% block content %}
<div class="container" style="max-width: 1000px;">
    <h1 style="font-size: 2rem; color: #000000; margin-bottom: 1rem;">Checkout</h1>
    <p style="color: #666; margin-bottom: 2rem;">
        Complete your order by selecting payment options and providing proof of payment where required.
        Vendors will confirm once they receive the funds.
    </p>
    
    {% if messages %}
        {% for message in messages %}
            <div class="message message-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-header">Shipping Information</div>
            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                    <div class="form-group">
                        <label for="shipping_address">Delivery Address *</label>
                        <textarea id="shipping_address" name="shipping_address" rows="3" required>{{ form_data.shipping_address }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="shipping_city">City / Town *</label>
                        <input type="text" id="shipping_city" name="shipping_city" value="{{ form_data.shipping_city }}" required>
                    </div>
                    <div class="form-group">
                        <label for="shipping_country">Country *</label>
                        <input type="text" id="shipping_country" name="shipping_country" value="{{ form_data.shipping_country }}" required>
                    </div>
                    <div class="form-group">
                        <label for="shipping_phone">Contact Phone *</label>
                        <input type="text" id="shipping_phone" name="shipping_phone" value="{{ form_data.shipping_phone }}" required>
                    </div>
                </div>
            </div>
        </div>
        
        {% for key, group in vendor_groups.items %}
        <div class="card vendor-delivery-card" style="margin-bottom: 2rem;"
             data-group-key="{{ group.key }}"
             data-vendor-lat="{% if group.vendor_location.latitude %}{{ group.vendor_location.latitude }}{% endif %}"
             data-vendor-lng="{% if group.vendor_location.longitude %}{{ group.vendor_location.longitude }}{% endif %}"
             data-base-fee="{% if group.vendor_location.base_fee is not None %}{{ group.vendor_location.base_fee }}{% endif %}"
             data-per-km="{% if group.vendor_location.per_km_fee %}{{ group.vendor_location.per_km_fee }}{% endif %}"
             data-free-radius="{% if group.vendor_location.free_radius %}{{ group.vendor_location.free_radius }}{% endif %}"
             data-google-key="{{ google_maps_api_key }}">
            <div class="card-header">
                {% if group.vendor %}
                    Payment for {{ group.vendor.get_full_name|default:group.vendor.username }}
                {% else %}
                    Payment for {{ group.offline_details.name }}
                {% endif %}
            </div>
            <div style="padding: 1.5rem;">
                <h3 style="font-size: 1.2rem; color: #000000; margin-bottom: 1rem;">Items</h3>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 1.5rem;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e0e0e0;">
                            <th style="padding: 0.75rem; text-align: left;">Product</th>
                            <th style="padding: 0.75rem; text-align: center;">Qty</th>
                            <th style="padding: 0.75rem; text-align: right;">Price</th>
                            <th style="padding: 0.75rem; text-align: right;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in group.items %}
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 0.75rem;">{{ item.product.name }}</td>
                            <td style="padding: 0.75rem; text-align: center;">{{ item.quantity }}</td>
                            <td style="padding: 0.75rem; text-align: right;">${{ item.price|floatformat:2 }}</td>
                            <td style="padding: 0.75rem; text-align: right;">${{ item.subtotal|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="padding: 0.75rem; text-align: right; font-weight: bold;">Subtotal</td>
                            <td style="padding: 0.75rem; text-align: right; font-weight: bold;">${{ group.subtotal|floatformat:2 }}</td>
                        </tr>
                    </tfoot>
                </table>
                
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.2rem; color: #000000; margin-bottom: 0.75rem;">Payment Method</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
                        {% for option in group.payment_options %}
                        <label style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; background-color: #f8f8f8;">
                            <input type="radio" name="payment_method_{{ group.key }}" value="{{ option.code }}"
                                {% if group.form_defaults.payment_method == option.code %}checked{% endif %}
                                required>
                            <strong>{{ option.label }}</strong>
                            {% if option.phone %}
                            <div style="font-size: 0.9rem; color: #333; margin-top: 0.25rem;">
                                Pay to: <strong>{{ option.phone }}</strong>
                                {% if option.merchant_name %}
                                <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                    Account Name: <strong>{{ option.merchant_name }}</strong>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if option.instructions %}
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                                {{ option.instructions }}
                            </div>
                            {% endif %}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="form-group" style="margin: 1.5rem 0;">
                    <label style="display: block; font-weight: bold; margin-bottom: 0.75rem;">Delivery Option *</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
                        {% for option in group.delivery_options %}
                        <label style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 0.75rem; background-color: #fafafa; cursor: pointer;">
                            <input type="radio"
                                   name="delivery_option_{{ group.key }}"
                                   value="{{ option.code }}"
                                   data-requires-custom="{{ option.requires_custom|yesno:'true,false' }}"
                                   data-option-fee="{{ option.fee|default:'' }}"
                                   data-has-map="{{ option.requires_map|default_if_none:False|yesno:'true,false' }}"
                                   {% if group.form_defaults.delivery_option == option.code %}checked{% endif %}
                                   required>
                            <div style="font-weight: 600; margin-top: 0.5rem;">{{ option.label }}</div>
                            {% if option.fee %}
                            <div style="color: #000000; font-weight: bold;">${{ option.fee }}</div>
                            {% endif %}
                            <div style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">{{ option.description }}</div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <div id="delivery_fee_display_{{ group.key }}" style="margin-bottom: 1rem; padding: 0.75rem; background-color: #f8f8f8; border-radius: 8px; display: none;">
                    <strong>Estimated Delivery Fee: $<span id="delivery_fee_amount_{{ group.key }}">0.00</span></strong>
                </div>
                
                <div id="custom_delivery_section_{{ group.key }}" style="display: none;">
                    {% if group.vendor_location and group.vendor_location.latitude and group.vendor_location.longitude %}
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="delivery_address_{{ group.key }}">Delivery Address *</label>
                            <input type="text" id="delivery_address_{{ group.key }}" name="delivery_address_{{ group.key }}"
                                   placeholder="Enter or select delivery address"
                                   value="{{ group.form_defaults.delivery_address|default:form_data.shipping_address }}">
                            <div id="delivery_map_{{ group.key }}" style="width: 100%; height: 300px; border: 1px solid #e0e0e0; border-radius: 8px; margin: 0.5rem 0;"></div>
                            <small style="color: #666;">Click on the map to set the delivery point.</small>
                        </div>
                        <div class="form-group">
                            <label for="delivery_distance_{{ group.key }}">Distance from vendor (km) *</label>
                            <input type="number" step="0.1" min="0" id="delivery_distance_{{ group.key }}" name="delivery_distance_{{ group.key }}"
                                   value="{{ group.form_defaults.delivery_distance }}"
                                   readonly style="background-color: #f5f5f5;">
                            <small style="color: #666;" id="distance_note_{{ group.key }}">Distance will be calculated automatically from the map.</small>
                        </div>
                    </div>
                    {% else %}
                    <div style="background-color: #fff3cd; border: 1px solid #ffe699; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; color: #856404;">
                        <strong>Vendor location not set:</strong> Please enter the delivery distance manually.
                    </div>
                    <div class="form-group">
                        <label for="delivery_distance_{{ group.key }}">Distance from vendor (km) *</label>
                        <input type="number" step="0.1" min="0" id="delivery_distance_{{ group.key }}" name="delivery_distance_{{ group.key }}"
                               value="{{ group.form_defaults.delivery_distance }}">
                        <small style="color: #666;" id="distance_note_{{ group.key }}">Enter the estimated distance.</small>
                    </div>
                    {% endif %}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label for="payer_name_{{ group.key }}">Payment Sender Name *</label>
                        <input type="text" id="payer_name_{{ group.key }}" name="payer_name_{{ group.key }}"
                               value="{{ group.form_defaults.payer_name }}" required
                               placeholder="Customer name on mobile wallet account">
                    </div>
                    <div class="form-group">
                        <label for="delivery_city_{{ group.key }}">Delivery City / Area *</label>
                        <input type="text" id="delivery_city_{{ group.key }}" name="delivery_city_{{ group.key }}"
                               value="{{ group.form_defaults.delivery_city|default:form_data.shipping_city }}" required>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="proof_{{ group.key }}">Proof of payment</label>
                    <input type="file" id="proof_{{ group.key }}" name="proof_{{ group.key }}" accept="image/*,application/pdf">
                    <small style="color: #666; display: block; margin-top: 0.4rem;">
                        Upload the receipt or screenshot after sending the payment. Required for mobile wallet payments.
                    </small>
                </div>
                
                {% if not group.vendor %}
                <div style="background-color: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 8px; padding: 1rem; font-size: 0.9rem; color: #2e7d32;">
                    This order will be managed by Mushanai on behalf of {{ group.offline_details.name }}. Our team will confirm your payment and arrange delivery.
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
        <button type="submit" class="btn btn-primary" style="padding: 0.75rem 2rem;">Place Order</button>
    </form>
</div>

{% if google_maps_api_key %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>
{% endif %}

<script>
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lat2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function calculateDeliveryFee(distance, vendorSettings) {
    if (!vendorSettings || vendorSettings.perKm === null) {
        return vendorSettings.baseFee || 0;
    }
    let fee = vendorSettings.baseFee || 0;
    if (vendorSettings.freeRadius && distance <= vendorSettings.freeRadius) {
        return 0;
    }
    let chargeableDistance = distance;
    if (vendorSettings.freeRadius) {
        chargeableDistance = Math.max(0, distance - vendorSettings.freeRadius);
    }
    fee += vendorSettings.perKm * chargeableDistance;
    return fee;
}

async function calculateDistanceMatrix(origin, destination, apiKey) {
    if (!apiKey) return null;
    try {
        const response = await fetch(
            `https://maps.googleapis.com/maps/api/distancematrix/json?origins=${origin.lat},${origin.lng}&destinations=${destination.lat},${destination.lng}&key=${apiKey}&units=metric`
        );
        const data = await response.json();
        if (data.rows && data.rows[0] && data.rows[0].elements && data.rows[0].elements[0].status === 'OK') {
            return data.rows[0].elements[0].distance.value / 1000;
        }
    } catch (error) {
        console.error('Distance Matrix API error:', error);
    }
    return null;
}

document.querySelectorAll('.vendor-delivery-card').forEach(function(card) {
    const groupKey = card.dataset.groupKey;
    const optionInputs = card.querySelectorAll('input[name="delivery_option_' + groupKey + '"]');
    const customSection = card.querySelector('#custom_delivery_section_' + groupKey);
    const distanceInput = card.querySelector('#delivery_distance_' + groupKey);
    const feeDisplay = card.querySelector('#delivery_fee_display_' + groupKey);
    const feeAmount = card.querySelector('#delivery_fee_amount_' + groupKey);
    const mapDiv = card.querySelector('#delivery_map_' + groupKey);
    const deliveryAddressInput = card.querySelector('#delivery_address_' + groupKey);
    const distanceNote = card.querySelector('#distance_note_' + groupKey);
    const googleMapsApiKey = card.dataset.googleKey || '';
    const vendorLat = card.dataset.vendorLat ? parseFloat(card.dataset.vendorLat) : null;
    const vendorLng = card.dataset.vendorLng ? parseFloat(card.dataset.vendorLng) : null;
    const vendorLocation = (vendorLat !== null && vendorLng !== null) ? { lat: vendorLat, lng: vendorLng } : null;
    const distanceSettings = {
        baseFee: card.dataset.baseFee ? parseFloat(card.dataset.baseFee) : 0,
        perKm: card.dataset.perKm ? parseFloat(card.dataset.perKm) : null,
        freeRadius: card.dataset.freeRadius ? parseFloat(card.dataset.freeRadius) : null,
    };
    
    let deliveryMap;
    let deliveryMarker;
    let deliveryAutocomplete;
    let mapInitialized = false;
    
    function initDeliveryMap() {
        if (mapInitialized || !mapDiv || !vendorLocation || typeof google === 'undefined' || !google.maps) return;
        mapInitialized = true;
        deliveryMap = new google.maps.Map(mapDiv, {
            center: vendorLocation,
            zoom: 12,
        });
        new google.maps.Marker({
            position: vendorLocation,
            map: deliveryMap,
            title: 'Vendor Location',
            icon: { url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png' }
        });
        if (deliveryAddressInput) {
            deliveryAutocomplete = new google.maps.places.Autocomplete(deliveryAddressInput, {
                componentRestrictions: { country: 'zw' },
                fields: ['formatted_address', 'geometry']
            });
            deliveryAutocomplete.addListener('place_changed', function() {
                const place = deliveryAutocomplete.getPlace();
                if (place.geometry) {
                    deliveryMap.setCenter(place.geometry.location);
                    deliveryMap.setZoom(15);
                    setDeliveryMarker(place.geometry.location);
                    processDestination(place.geometry.location);
                }
            });
        }
        deliveryMap.addListener('click', function(event) {
            setDeliveryMarker(event.latLng);
            processDestination(event.latLng);
        });
    }
    
    function setDeliveryMarker(location) {
        if (!deliveryMap) return;
        if (deliveryMarker) {
            deliveryMarker.setPosition(location);
        } else {
            deliveryMarker = new google.maps.Marker({
                position: location,
                map: deliveryMap,
                draggable: true
            });
            deliveryMarker.addListener('dragend', function() {
                processDestination(deliveryMarker.getPosition());
            });
        }
    }
    
    async function processDestination(location) {
        if (!vendorLocation || !location) return;
        if (distanceNote) distanceNote.textContent = 'Calculating distance...';
        const destination = { lat: location.lat(), lng: location.lng() };
        let distance = null;
        if (googleMapsApiKey) {
            distance = await calculateDistanceMatrix(vendorLocation, destination, googleMapsApiKey);
        }
        if (!distance) {
            distance = calculateDistance(vendorLocation.lat, vendorLocation.lng, destination.lat(), destination.lng());
        }
        if (distanceInput) {
            distanceInput.value = distance.toFixed(1);
            distanceInput.dispatchEvent(new Event('input'));
        }
        if (distanceNote) distanceNote.textContent = `Distance: ${distance.toFixed(1)} km`;
    }
    
    function handleOptionChange(input) {
        const requiresCustom = input.dataset.requiresCustom === 'true';
        if (customSection) {
            customSection.style.display = requiresCustom ? 'block' : 'none';
        }
        if (deliveryAddressInput) {
            deliveryAddressInput.required = requiresCustom && !!mapDiv;
        }
        if (distanceInput) {
            distanceInput.required = requiresCustom;
        }
        if (requiresCustom) {
            if (feeDisplay) feeDisplay.style.display = 'none';
            if (distanceInput) {
                if (mapDiv && vendorLocation) {
                    distanceInput.readOnly = true;
                    distanceInput.style.backgroundColor = '#f5f5f5';
                    initDeliveryMap();
                } else {
                    distanceInput.readOnly = false;
                    distanceInput.style.backgroundColor = '#ffffff';
                }
            }
        } else {
            if (distanceInput) {
                distanceInput.value = '';
                distanceInput.readOnly = true;
                distanceInput.style.backgroundColor = '#f5f5f5';
            }
            if (feeDisplay && feeAmount) {
                const feeValue = parseFloat(input.dataset.optionFee || '0');
                if (!isNaN(feeValue) && feeValue > 0) {
                    feeAmount.textContent = feeValue.toFixed(2);
                    feeDisplay.style.display = 'block';
                } else {
                    feeDisplay.style.display = 'none';
                }
            }
        }
    }
    
    optionInputs.forEach(function(input) {
        input.addEventListener('change', function() {
            handleOptionChange(this);
        });
    });
    const checkedInput = Array.from(optionInputs).find(input => input.checked);
    if (checkedInput) {
        handleOptionChange(checkedInput);
    }
    
    if (distanceInput) {
        distanceInput.addEventListener('input', function() {
            const distance = parseFloat(this.value) || 0;
            if (distance > 0 && distanceSettings.perKm !== null) {
                const fee = calculateDeliveryFee(distance, distanceSettings);
                if (feeDisplay && feeAmount) {
                    feeAmount.textContent = fee.toFixed(2);
                    feeDisplay.style.display = 'block';
                }
            } else if (feeDisplay) {
                feeDisplay.style.display = 'none';
            }
        });
        if (distanceInput.value) {
            distanceInput.dispatchEvent(new Event('input'));
        }
    }
    
    if (typeof google !== 'undefined' && google.maps) {
        initDeliveryMap();
    } else {
        window.addEventListener('load', function() {
            if (typeof google !== 'undefined' && google.maps) {
                initDeliveryMap();
            }
        });
    }
});
</script>
{% endblock %}

