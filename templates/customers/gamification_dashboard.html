{% extends 'base.html' %}

{% block title %}My Impact & Achievements - Mushanai{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <h1 style="font-size: 2.5rem; color: #000000;">Impact & Achievements</h1>
        <p style="color: #666;">Track your journey supporting local vendors and community projects.</p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin: 2rem 0;">
        <div class="stat-card">
            <div class="stat-card-value">{{ impact_metrics.impact_points }}</div>
            <div class="stat-card-label">Impact Points</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-value">{{ impact_metrics.total_badges_earned }}</div>
            <div class="stat-card-label">Badges Earned</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-value">{{ impact_metrics.projects_supported_count }}</div>
            <div class="stat-card-label">Projects Supported</div>
        </div>
        {% if current_level %}
        <div class="stat-card" style="border-left-color: {{ current_level.color }};">
            <div class="stat-card-value">{{ current_level.display_name }}</div>
            <div class="stat-card-label">Impact Level</div>
        </div>
        {% endif %}
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
        <div class="card" style="padding: 1.5rem; border: 1px solid #e0e0e0; border-radius: 8px;">
            <h2 style="font-size: 1.6rem; color: #000000; margin-bottom: 1rem;">Impact Levels</h2>
            <ul style="list-style: none; padding: 0; margin: 0;">
                {% for level in impact_levels %}
                <li style="padding: 0.75rem; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 0.5rem; background-color: {% if current_level and level.id == current_level.id %}#f8f8f8{% else %}#ffffff{% endif %}; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; color: {{ level.color }};">{{ level.display_name }}</span>
                    <span style="color: #666; font-size: 0.9rem;">{{ level.min_points }} pts</span>
                </li>
                {% empty %}
                <li style="color: #666;">Impact levels coming soon.</li>
                {% endfor %}
            </ul>
        </div>
        <div class="card" style="padding: 1.5rem; border: 1px solid #e0e0e0; border-radius: 8px;">
            <h2 style="font-size: 1.6rem; color: #000000; margin-bottom: 1rem;">My Achievements</h2>
            {% if achievements %}
            <ul style="list-style: none; padding: 0; margin: 0;">
                {% for achievement in achievements %}
                <li style="padding: 0.75rem; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 0.5rem; background-color: {% if achievement.status == 'EARNED' %}#e8f5e9{% else %}#ffffff{% endif %};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #000000;">{{ achievement.badge.name }}</strong>
                            <div style="color: #666; font-size: 0.9rem;">{{ achievement.badge.description }}</div>
                            {% if achievement.status == 'EARNED' and achievement.earned_at %}
                            <div style="color: #2e7d32; font-size: 0.85rem;">Earned {{ achievement.earned_at|date:"F d, Y" }}</div>
                            {% else %}
                            <div style="color: #999; font-size: 0.85rem;">Progress: {{ achievement.progress }}%</div>
                            {% endif %}
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p style="color: #666;">No badges yet. Keep supporting local vendors and projects to earn achievements!</p>
            {% endif %}
        </div>
    </div>
    
    <div style="margin-bottom: 3rem;">
        <h2 style="font-size: 2rem; color: #000000; margin-bottom: 1rem;">Leaderboards</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div class="card" style="padding: 1.5rem; border: 1px solid #e0e0e0; border-radius: 8px;">
                <h3 style="font-size: 1.4rem; color: #000000; margin-bottom: 1rem;">Project Contributions</h3>
                {% if project_leaderboard %}
                <ol style="padding-left: 1.2rem;">
                    {% for entry in project_leaderboard %}
                    <li style="margin-bottom: 0.5rem; color: {% if entry.customer_id == request.user.id %}#be8400{% else %}#000000{% endif %};">
                        {{ entry.customer.username }} - {{ entry.score|floatformat:2 }} pts
                    </li>
                    {% endfor %}
                </ol>
                {% else %}
                <p style="color: #666;">No contributions recorded yet.</p>
                {% endif %}
            </div>
            <div class="card" style="padding: 1.5rem; border: 1px solid #e0e0e0; border-radius: 8px;">
                <h3 style="font-size: 1.4rem; color: #000000; margin-bottom: 1rem;">Impact Points</h3>
                {% if impact_leaderboard %}
                <ol style="padding-left: 1.2rem;">
                    {% for entry in impact_leaderboard %}
                    <li style="margin-bottom: 0.5rem; color: {% if entry.customer_id == request.user.id %}#be8400{% else %}#000000{% endif %};">
                        {{ entry.customer.username }} - {{ entry.score|floatformat:0 }} pts
                    </li>
                    {% endfor %}
                </ol>
                {% else %}
                <p style="color: #666;">No impact points recorded yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div>
        <h2 style="font-size: 2rem; color: #000000; margin-bottom: 1rem;">Community Challenges</h2>
        {% if active_challenges %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">
            {% for challenge in active_challenges %}
            <div class="card" style="padding: 1.5rem; border: 1px solid #e0e0e0; border-radius: 8px;">
                <h3 style="font-size: 1.4rem; color: #000000; margin-bottom: 0.5rem;">{{ challenge.title }}</h3>
                <p style="color: #666; margin-bottom: 0.5rem;">{{ challenge.description }}</p>
                <div style="color: #999; font-size: 0.85rem; margin-bottom: 0.75rem;">
                    {{ challenge.start_date|date:"M d" }} - {{ challenge.end_date|date:"M d, Y" }}
                </div>
                <div style="margin-bottom: 0.75rem;">
                    <strong style="color: #000000;">Target:</strong> {{ challenge.target_value|floatformat:0 }}
                </div>
                {% if challenge.participation %}
                <div style="margin-bottom: 0.75rem;">
                    <div style="color: #666; font-size: 0.9rem;">Your progress: {{ challenge.participation.progress_percentage|floatformat:1 }}%</div>
                    <div style="width: 100%; height: 8px; background-color: #e0e0e0; border-radius: 4px; overflow: hidden;">
                        <div style="width: {{ challenge.participation.progress_percentage }}%; height: 100%; background-color: #be8400;"></div>
                    </div>
                </div>
                {% endif %}
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    {% if challenge.reward_badge %}
                    <span style="background-color: #f8f8f8; border-radius: 4px; padding: 0.25rem 0.5rem; font-size: 0.85rem;">üèÖ {{ challenge.reward_badge.name }}</span>
                    {% endif %}
                    {% if challenge.reward_points %}
                    <span style="background-color: #f8f8f8; border-radius: 4px; padding: 0.25rem 0.5rem; font-size: 0.85rem;">+{{ challenge.reward_points }} pts</span>
                    {% endif %}
                </div>
                {% if not challenge.participation %}
                <form method="post" action="{% url 'join_challenge' challenge.id %}" style="margin-top: 1rem;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1.5rem;">Join Challenge</button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="color: #666;">No active community challenges right now. Check back soon!</p>
        {% endif %}
    </div>
</div>
{% endblock %}
