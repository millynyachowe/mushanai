{% extends 'base.html' %}
{% load product_tags %}

{% block title %}Product Reviews - Vendor Dashboard{% endblock %}

{% block content %}
<div class="container">
    <div style="margin-bottom: 2rem;">
        <h1 style="font-size: 2.5rem; color: #000000; margin-bottom: 0.5rem;">Product Reviews</h1>
        <p style="color: #666;">Manage and respond to reviews for your products</p>
        <div style="margin-top: 1rem;">
            <a href="{% url 'vendor_dashboard' %}" class="btn btn-outline" style="padding: 0.5rem 1rem;">‚Üê Back to Dashboard</a>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="card" style="margin-bottom: 2rem;">
        <form method="get" action="{% url 'vendor_reviews' %}" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: end;">
            <div class="form-group">
                <label for="status" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Filter by Status</label>
                <select id="status" name="status" style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 4px;" onchange="this.form.submit()">
                    <option value="all" {% if filter_status == 'all' %}selected{% endif %}>All Reviews</option>
                    <option value="approved" {% if filter_status == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>Pending Approval</option>
                    <option value="responded" {% if filter_status == 'responded' %}selected{% endif %}>With Response</option>
                    <option value="not_responded" {% if filter_status == 'not_responded' %}selected{% endif %}>Needs Response</option>
                </select>
            </div>
            <div class="form-group">
                <label for="rating" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Filter by Rating</label>
                <select id="rating" name="rating" style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 4px;" onchange="this.form.submit()">
                    <option value="all" {% if filter_rating == 'all' %}selected{% endif %}>All Ratings</option>
                    <option value="5" {% if filter_rating == '5' %}selected{% endif %}>5 Stars</option>
                    <option value="4" {% if filter_rating == '4' %}selected{% endif %}>4 Stars</option>
                    <option value="3" {% if filter_rating == '3' %}selected{% endif %}>3 Stars</option>
                    <option value="2" {% if filter_rating == '2' %}selected{% endif %}>2 Stars</option>
                    <option value="1" {% if filter_rating == '1' %}selected{% endif %}>1 Star</option>
                </select>
            </div>
        </form>
    </div>
    
    <!-- Reviews List -->
    {% if reviews %}
    <div class="reviews-list">
        {% for review in reviews %}
        <div class="card" style="margin-bottom: 1.5rem; padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div>
                    <h3 style="margin-bottom: 0.5rem; color: #000000;">
                        <a href="{% url 'product_detail' review.product.slug %}" style="color: #be8400; text-decoration: none;">{{ review.product.name }}</a>
                    </h3>
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <span style="color: #be8400; font-size: 1.2rem;">{{ review.rating|stars }}</span>
                        <span class="review-author">{{ review.customer.username }}</span>
                        {% if review.is_verified_purchase %}
                        <span class="verified-badge" style="display: inline-block; background-color: #be8400; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">‚úì Verified Purchase</span>
                        {% endif %}
                        {% if not review.is_approved %}
                        <span style="display: inline-block; background-color: #ffc107; color: #000; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Pending Approval</span>
                        {% endif %}
                    </div>
                    <div class="review-date" style="color: #666; font-size: 0.9rem;">{{ review.created_at|date:"F d, Y" }}</div>
                </div>
            </div>
            
            {% if review.title %}
            <h4 style="margin: 0.5rem 0; color: #000000;">{{ review.title }}</h4>
            {% endif %}
            
            <p style="color: #333; margin: 1rem 0; line-height: 1.6;">{{ review.comment|linebreaks }}</p>
            
            <!-- Review Photos -->
            {% if review.photos.exists %}
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin: 1rem 0;">
                {% for photo in review.photos.all %}
                <img src="{{ photo.image.url }}" alt="{{ photo.alt_text|default:review.product.name }}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 4px;">
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Vendor Response -->
            {% if review.vendor_response %}
            <div style="background-color: #f8f8f8; border-left: 4px solid #be8400; padding: 1rem; margin-top: 1rem; border-radius: 4px;">
                <div style="font-weight: bold; color: #000000; margin-bottom: 0.5rem;">Your Response</div>
                {% if review.vendor_response_date %}
                <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.5rem;">{{ review.vendor_response_date|date:"F d, Y" }}</div>
                {% endif %}
                <p style="color: #333; margin: 0; line-height: 1.6;">{{ review.vendor_response|linebreaks }}</p>
                <form method="post" action="{% url 'vendor_response' review.id %}" style="margin-top: 1rem;">
                    {% csrf_token %}
                    <textarea name="response" rows="3" placeholder="Update your response..." required style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 4px;">{{ review.vendor_response }}</textarea>
                    <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem; padding: 0.5rem 1rem;">Update Response</button>
                </form>
            </div>
            {% else %}
            <!-- Vendor can add response -->
            {% if review.is_approved %}
            <div style="margin-top: 1rem; padding: 1rem; background-color: #f0f0f0; border-radius: 4px;">
                <h4 style="margin-bottom: 0.5rem; color: #000000;">Respond to this review</h4>
                <form method="post" action="{% url 'vendor_response' review.id %}">
                    {% csrf_token %}
                    <textarea name="response" rows="3" placeholder="Thank the customer for their feedback or address their concerns..." required style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 4px;"></textarea>
                    <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem; padding: 0.5rem 1rem;">Post Response</button>
                </form>
            </div>
            {% else %}
            <p style="color: #666; margin-top: 1rem; font-style: italic;">You can respond to this review after it's approved by admin.</p>
            {% endif %}
            {% endif %}
            
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0; display: flex; gap: 1rem; font-size: 0.9rem; color: #666;">
                <span>üëç Helpful: {{ review.helpful_count }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card" style="text-align: center; padding: 3rem;">
        <p style="color: #666;">No reviews found matching your filters.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

